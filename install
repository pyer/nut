#!/bin/sh
set -e

root=$(pwd)
classes="target/classes"
options="-d $root/target/classes -cp $root/target/classes:../nutRepository/nut/logging/Log-1.0.jar -deprecation -Xlint:unchecked"
rm -r ../nutRepository
mkdir ../nutRepository

cp -a junit ../nutRepository

mkdir -p target/classes 

echo "Build log"
cd logging/src/java
javac $options Log.java

cd $root
mkdir -p ../nutRepository/nut/logging
jar cf ../nutRepository/nut/logging/Log-1.0.jar -C target/classes .

echo "Build core"
cd $root
cd core/src/java/util/
javac $options Os.java
cd dag
javac $options CycleDetectedException.java Vertex.java CycleDetector.java TopologicalSorter.java DAG.java
cd ../../xml
javac $options XmlPullParserException.java XmlPullParser.java XmlSerializer.java
cd ../artifact
javac $options InvalidArtifactRTException.java Artifact.java
cd ../model
javac $options Plugin.java PluginContainer.java Dependency.java Parent.java Build.java Model.java 
javac $options xmlReader.java xmlWriter.java EffectiveModel.java 
cd ../project/validation
javac $options ModelValidationException.java ModelValidator.java 
cd ..
javac $options InvalidDependencyVersionException.java InvalidProjectModelException.java DuplicateProjectException.java NutProject.java ProjectBuildingException.java ProjectBuilder.java ProjectSorter.java
cd ../execution
javac $options BuildFailureException.java ExecutionException.java NutClassRealm.java NutClassLoader.java PluginManager.java 
cd ..
javac $options Nut.java

cd $root
mkdir -p ../nutRepository/nut/core
jar cf ../nutRepository/nut/core/Nut-1.0.jar -C target/classes .

sudo rm /usr/bin/nut
sudo ln -s $root/nut /usr/bin/nut

echo "Build plugins"
cd $root
mkdir -p ../nutRepository/nut/plugins

rm -r target/classes/*
javac -d target/classes -cp ../nutRepository/nut/logging/Log-1.0.jar plugins/cleaner/src/java/cleaner.java -Xlint:unchecked
jar cf ../nutRepository/nut/plugins/cleaner-1.0.jar -C target/classes .

rm -r target/classes/*
javac -d target/classes -cp ../nutRepository/nut/logging/Log-1.0.jar plugins/installer/src/java/installer.java -Xlint:unchecked
jar cf ../nutRepository/nut/plugins/installer-1.0.jar -C target/classes .

rm -r target/classes/*
javac -d target/classes -cp ../nutRepository/nut/logging/Log-1.0.jar plugins/jarArchiver/src/java/jarArchiver.java -Xlint:unchecked
jar cf ../nutRepository/nut/plugins/jarArchiver-1.0.jar -C target/classes .

rm -r target/classes/*
javac -d target/classes -cp ../nutRepository/nut/logging/Log-1.0.jar plugins/javaCompiler/src/java/javaCompiler.java -Xlint:unchecked
jar cf ../nutRepository/nut/plugins/javaCompiler-1.0.jar -C target/classes .

rm -r target/classes/*
javac -d target/classes -cp ../nutRepository/nut/logging/Log-1.0.jar:../nutRepository/junit/junit-4.10.jar plugins/junitRunner/src/java/junitRunner.java -Xlint:unchecked
jar cf ../nutRepository/nut/plugins/junitRunner-1.0.jar -C target/classes .

echo "Build packaging"
mkdir -p ../nutRepository/nut/packaging
cp packaging/src/resources/file.xml    ../nutRepository/nut/packaging/file-1.0.xml
cp packaging/src/resources/jar.xml     ../nutRepository/nut/packaging/jar-1.0.xml
cp packaging/src/resources/modules.xml ../nutRepository/nut/packaging/modules-1.0.xml

rm -r target
