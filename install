#!/bin/sh
set -e

cd $(dirname $0)
root=$(pwd)
tmp=$(grep -P -m 1 "<version>(.*)</version>" nut.xml)
NUT_VERSION=$(expr $tmp : '<version>\(.*\)</version>')
NUT_HOME="$HOME/nutRepository"

echo "Build nut"
cat <<EOF >nut
#!/bin/bash
# Nut start up script
# ----------------------------------------------------------------------------
export NUT_VERSION=$NUT_VERSION
export NUT_HOME=$NUT_HOME
java -Xmx512M -classpath ./target/test-classes:\$NUT_HOME/nut/Nut-\$NUT_VERSION.jar:\$NUT_HOME/org/codehaus/plexus/plexus-utils-3.0.jar:\$NUT_HOME/com/beust/jcommander-1.7.jar:\$NUT_HOME/org/testng/testng-6.8.7.jar nut.Nut "-Dversion=\$NUT_VERSION" "-Dhome=\$NUT_HOME" \$*
EOF

sudo install nut /usr/bin/

echo "Build repository"
[ -d $NUT_HOME ] && rm -r $NUT_HOME
mkdir -p $NUT_HOME/nut
cp -a localRepository/* $NUT_HOME/

mkdir -p target/classes 


cd $root
echo "Build classes"
options="-d $root/target/classes -cp $root/target/classes:$NUT_HOME/org/codehaus/plexus/plexus-utils-3.0.jar -deprecation -Xlint:unchecked"
cd $root
cd src/java/logging
javac $options Log.java
cd ../xml
javac $options XmlPullParserException.java XmlPullParser.java XmlSerializer.java
cd ../artifact
javac $options InvalidArtifactRTException.java Artifact.java
cd ../model
javac $options Goal.java Dependency.java Build.java Model.java xmlReader.java xmlWriter.java EffectiveModel.java 
cd ../project/validation
javac $options ModelValidationException.java ModelValidator.java 
cd ..
javac $options InvalidDependencyVersionException.java InvalidProjectModelException.java DuplicateProjectException.java NutProject.java ProjectBuildingException.java ProjectBuilder.java ProjectSorter.java
cd ../execution
javac $options BuildFailureException.java ExecutionException.java Execution.java 
cd ../goals
echo "Build goals"
javac $options clean.java
javac $options compile.java
javac $options install.java
javac $options pack.java
#javac $options test.java
cd ..
javac $options Nut.java

cd $root
mkdir -p $NUT_HOME/nut
jar cf $NUT_HOME/nut/Nut-$NUT_VERSION.jar -C target/classes .
rm -r target

echo "Build packaging"
mkdir -p $NUT_HOME/nut/packaging
cp src/resources/packaging/xml.xml     $NUT_HOME/nut/packaging/xml-$NUT_VERSION.xml
cp src/resources/packaging/jar.xml     $NUT_HOME/nut/packaging/jar-$NUT_VERSION.xml
cp src/resources/packaging/war.xml     $NUT_HOME/nut/packaging/war-$NUT_VERSION.xml
cp src/resources/packaging/modules.xml $NUT_HOME/nut/packaging/modules-$NUT_VERSION.xml
echo "Done."
